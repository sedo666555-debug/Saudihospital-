<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€“ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ ÙƒØ³Ù„Ø§</title>
  <style>
    :root{
      --bg:#f0f7ff;        /* Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ ÙØ§ØªØ­Ø© */
      --card:#ffffff;      /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨ÙŠØ¶Ø§Ø¡ */
      --muted:#e6f2ff;     /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© */
      --ink:#1e3a8a;       /* Ù†Øµ Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚ */
      --ink-dim:#4b5563;   /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
      --brand:#3b82f6;     /* Ù„ÙˆÙ† Ø±Ø¦ÙŠØ³ÙŠ Ø£Ø²Ø±Ù‚ */
      --accent:#8b5cf6;    /* Ù„ÙˆÙ† Ø«Ø§Ù†ÙˆÙŠ Ø¨Ù†ÙØ³Ø¬ÙŠ */
      --ok:#10b981;        /* Ù„ÙˆÙ† Ø§Ù„Ù†Ø¬Ø§Ø­ Ø£Ø®Ø¶Ø± */
      --warn:#f59e0b;      /* Ù„ÙˆÙ† Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
      --danger:#ef4444;    /* Ù„ÙˆÙ† Ø§Ù„Ø®Ø·Ø± Ø£Ø­Ù…Ø± */
      --radius:16px;
      --shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
      font-family:"Tajawal","Cairo",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      color:var(--ink);
      line-height:1.6;
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .card{
      background:var(--card);
      border:1px solid rgba(59, 130, 246, 0.15);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .p-24{padding:24px}
    .mt-16{margin-top:16px}.mt-24{margin-top:24px}.mt-32{margin-top:32px}.mb-16{margin-bottom:16px}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:700px){.grid-3,.grid-2,.grid-4{grid-template-columns:1fr}}
    h1{font-size:28px;margin:0 0 8px; color:var(--brand);}
    h2{font-size:22px;margin:0 0 8px;color:var(--accent)}
    p.muted{color:var(--ink-dim);margin:0}
    label{display:block;color:var(--ink-dim);font-size:14px;margin-bottom:6px}
    input,select,textarea{
      width:100%;padding:12px 14px;border:1px solid rgba(59, 130, 246, 0.3);
      border-radius:12px;background:#f8fafc;color:var(--ink);outline:none;
      transition: all 0.2s ease;
    }
    textarea{min-height:90px}
    input:focus,select:focus,textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(59, 130, 246, 0.15);
      background: white;
    }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{
      border:none;padding:12px 16px;border-radius:14px;
      background:var(--muted);color:var(--ink);cursor:pointer;
      font-weight:500;transition:all 0.2s ease;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .btn-primary{background:linear-gradient(135deg,var(--brand),#60a5fa);color:white}
    .btn-accent{background:linear-gradient(135deg,var(--accent),#a78bfa);color:white}
    .btn-ok{background:linear-gradient(135deg,var(--ok),#34d399);color:white}
    .btn-warn{background:linear-gradient(135deg,var(--warn),#fbbf24);color:white}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#f87171);color:white}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none !important}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(59, 130, 246, 0.15);text-align:right}
    .table th{color:var(--ink-dim);font-weight:600;background:var(--muted)}
    .badge{padding:4px 10px;border-radius:999px;background:#f1f5f9;border:1px solid rgba(59, 130, 246, 0.2);font-size:12px;color:var(--ink)}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding-bottom:16px;border-bottom:1px solid rgba(59, 130, 246, 0.15)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:50px;height:50px;border-radius:12px;background:#f8fafc;border:2px solid var(--brand);display:flex;align-items:center;justify-content:center;font-weight:bold;color:var(--brand);font-size:20px}
    .logo-img{width:50px;height:50px;object-fit:contain;border-radius:12px;border:2px solid var(--brand);padding:4px}
    .link{color:var(--brand);text-decoration:none;font-weight:500}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid rgba(59, 130, 246, 0.2);color:var(--ink-dim)}
    .footer{color:var(--ink-dim);font-size:12px;margin-top:24px;text-align:center;padding-top:16px;border-top:1px solid rgba(59, 130, 246, 0.15)}
    .permission-badge{
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      background: #f1f5f9;
      color: var(--ink);
    }
    .permission-read { background: #dbeafe; color: #1e40af; }
    .permission-write { background: #d1fae5; color: #065f46; }
    .permission-admin { background: #fef3c7; color: #92400e; }
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-grid {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 24px;
    }
    .settings-sidebar {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .settings-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .settings-menu li {
      margin-bottom: 8px;
    }
    .settings-menu a {
      display: block;
      padding: 12px;
      border-radius: 12px;
      text-decoration: none;
      color: var(--ink);
      transition: all 0.2s;
    }
    .settings-menu a:hover,
    .settings-menu a.active {
      background: var(--muted);
      color: var(--brand);
    }
    .settings-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }
    .user-table {
      width: 100%;
      border-collapse: collapse;
    }
    .user-table th,
    .user-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid rgba(59, 130, 246, 0.15);
    }
    .user-table th {
      background: var(--muted);
      color: var(--ink-dim);
    }
    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header mb-16">
      <div class="brand">
        <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ ÙƒØ³Ù„Ø§ -->
       <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ ÙƒØ³Ù„Ø§ -->
<img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰" class="logo-img">
        <div>
          <h1>Ù†Ø¸Ø§Ù… Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
          <p class="muted">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ â€“ ÙƒØ³Ù„Ø§</p>
        </div>
      </div>
      <div class="row">
        <span id="currentUser" class="chip">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
        <button class="btn" id="settingsBtn">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="btn" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <section id="screen-login" class="card p-24">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <p class="muted">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
      <div class="grid grid-2 mt-16">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="loginUser" placeholder="Ù…Ø«Ø§Ù„: admin" />
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
      </div>
      <div class="row mt-16">
        <button class="btn btn-primary" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        <span class="badge">Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: admin / 1234</span>
      </div>
    </section>

    <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <section id="screen-home" class="hidden">
      <div class="card p-24">
        <h2>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
        <p class="muted">Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©.</p>
        <div class="toolbar mt-16">
          <button class="btn btn-primary" id="newListBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„ÙØ³ØªÙ‘Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn btn-accent" id="reportsBtn">ğŸ“Š Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
          <button class="btn" id="backupBtn">â¤´ï¸ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
          <button class="btn" id="restoreBtn">â¤µï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
        </div>
      </div>

      <div class="card p-24 mt-24">
        <div class="row" style="justify-content:space-between">
          <h2>Ø§Ù„Ù„Ø³ØªÙ‘Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
          <div class="row">
            <input id="searchLists" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" />
          </div>
        </div>
        <table class="table mt-16" id="listsTable">
          <thead>
            <tr>
              <th>Ø§Ù„ÙŠÙˆÙ…</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù„Ø³ØªØ© Ù…Ø³ØªØ¹Ø¬Ù„Ø©)</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø±ÙŠØ± Ù„Ø³ØªØ© -->
    <section id="screen-editor" class="hidden">
      <div class="card p-24">
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù„Ø³ØªÙ‘Ø©</h2>
        <div class="grid grid-3 mt-16">
          <div>
            <label>Ø§Ù„ÙŠÙˆÙ…</label>
            <input id="listDay" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø­Ø¯" />
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="listDate" type="date" />
          </div>
          <div>
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ø³ØªØ© Ù…Ø³ØªØ¹Ø¬Ù„Ø© Ø£Ø®Ø±Ù‰</label>
            <input id="listNotes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
        </div>
        <div class="toolbar mt-16">
          <button class="btn" id="backToHomeFromEditor">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
          <button class="btn btn-ok" id="saveListBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù„Ø³ØªÙ‘Ø©</button>
          <button class="btn btn-warn" id="exportListBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="printListBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>

      <div class="card p-24 mt-24">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <p class="muted">Ø£Ø¶Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆÙÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¯ÙØªØ±.</p>
          </div>
          <button class="btn btn-primary" id="addOpBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</button>
        </div>

        <table class="table mt-16" id="opsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©<br><span class="muted" style="font-weight:400">ÙƒØ¨ÙŠØ±Ø© / Ù…ØªÙˆØ³Ø·Ø© / ØµØºÙŠØ±Ø©</span></th>
              <th>Ù†ÙˆØ¹ Ø§Ù„ØªØ®Ø¯ÙŠØ±<br><span class="muted" style="font-weight:400">ÙƒØ§Ù…Ù„ / Ù†ØµÙÙŠ</span></th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±</th>
              <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
              <th>Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <section id="screen-reports" class="hidden">
      <div class="card p-24">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2>Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            <p class="muted">Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø¯Ù‘Ø± Ø£Ùˆ Ø§Ù„Ù…Ø­Ø¶Ù‘Ø± Ø£Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ù…Ø¹ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©.</p>
          </div>
          <div class="toolbar">
            <button class="btn" id="backToHomeFromReports">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
            <button class="btn btn-warn" id="exportReportBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (CSV)</button>
            <button class="btn" id="printReportBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>

        <div class="grid grid-4 mt-16">
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù†)</label>
            <input id="filterFrom" type="date" />
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ù„Ù‰)</label>
            <input id="filterTo" type="date" />
          </div>
          <div>
            <label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
            <input id="filterDoctor" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" />
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±</label>
            <input id="filterAnesth" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±" />
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±</label>
            <input id="filterPrep" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±" />
          </div>
          <div>
            <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <input id="filterUnit" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø±Ø§Ø­Ø© Ø¹Ø§Ù…Ø©" />
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="filterOpType">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>ÙƒØ¨ÙŠØ±Ø©</option>
              <option>Ù…ØªÙˆØ³Ø·Ø©</option>
              <option>ØµØºÙŠØ±Ø©</option>
            </select>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„ØªØ®Ø¯ÙŠØ±</label>
            <select id="filterAnType">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option>ÙƒØ§Ù…Ù„</option>
              <option>Ù†ØµÙÙŠ</option>
            </select>
          </div>
        </div>

        <div class="toolbar mt-16">
          <button class="btn btn-primary" id="runSearchBtn">Ø¨Ø­Ø«</button>
          <button class="btn" id="clearFiltersBtn">Ù…Ø³Ø­ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª</button>
        </div>
      </div>

      <div class="card p-24 mt-24">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2>
          <div class="row" id="statsRow"></div>
        </div>
        <table class="table mt-16" id="reportTable">
          <thead>
            <tr>
              <th>Ø§Ù„ÙŠÙˆÙ…</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>#</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„ØªØ®dÙŠØ±</th>
              <th>Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±</th>
              <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
              <th>Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <section id="screen-settings" class="hidden">
      <div class="card p-24">
        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        <p class="muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù….</p>
        
        <div class="settings-grid mt-24">
          <div class="settings-sidebar">
            <ul class="settings-menu">
              <li><a href="#users" class="active" data-tab="users">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a></li>
              <li><a href="#permissions" data-tab="permissions">ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</a></li>
              <li><a href="#system" data-tab="system">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</a></li>
            </ul>
          </div>
          
          <div class="settings-content">
            <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
            <div id="users-tab">
              <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
              <p class="muted">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
              
              <div class="card mt-16" style="background: var(--muted);">
                <div class="p-24">
                  <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                  <div class="grid grid-3 mt-16">
                    <div>
                      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                      <input id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
                    </div>
                    <div>
                      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                      <input id="newUserPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
                    </div>
                    <div>
                      <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                      <select id="newUserRole">
                        <option value="admin">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                        <option value="write">Ù‚Ø±Ø§Ø¡Ø© ÙˆÙƒØªØ§Ø¨Ø©</option>
                        <option value="read">Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</option>
                      </select>
                    </div>
                  </div>
                  <div class="toolbar mt-16">
                    <button class="btn btn-primary" id="addUserBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
                  </div>
                </div>
              </div>
              
              <div class="mt-24">
                <h4>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h4>
                <table class="user-table mt-16">
                  <thead>
                    <tr>
                      <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                      <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody"></tbody>
                </table>
              </div>
            </div>
            
            <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
            <div id="permissions-tab" class="hidden">
              <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
              <p class="muted">ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
              
              <div class="card mt-24 p-24">
                <h4>Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</h4>
                <div class="grid grid-3 mt-16">
                  <div class="card p-16">
                    <h5>Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                    <p class="muted">ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</p>
                    <span class="permission-badge permission-admin">Admin</span>
                  </div>
                  <div class="card p-16">
                    <h5>Ù‚Ø±Ø§Ø¡Ø© ÙˆÙƒØªØ§Ø¨Ø©</h5>
                    <p class="muted">Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆÙ„ÙƒÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡Ø§ Ø£Ùˆ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</p>
                    <span class="permission-badge permission-write">Read/Write</span>
                  </div>
                  <div class="card p-16">
                    <h5>Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</h5>
                    <p class="muted">Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙ‚Ø· Ø¯ÙˆÙ† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù.</p>
                    <span class="permission-badge permission-read">Read Only</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <div id="system-tab" class="hidden">
              <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
              <p class="muted">ØªØ®ØµÙŠØµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©.</p>
              
              <div class="grid grid-2 mt-24">
                <div class="card p-16">
                  <h5>Ø§Ù„Ù…Ø¸Ù‡Ø±</h5>
                  <div class="mt-16">
                    <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ <span class="color-preview" id="primaryColorPreview" style="background: #3b82f6"></span></label>
                    <input type="color" id="primaryColor" value="#3b82f6" />
                  </div>
                  <div class="mt-16">
                    <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ <span class="color-preview" id="accentColorPreview" style="background: #8b5cf6"></span></label>
                    <input type="color" id="accentColor" value="#8b5cf6" />
                  </div>
                  <button class="btn btn-primary mt-16" id="saveThemeBtn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </div>
                
                <div class="card p-16">
                  <h5>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h5>
                  <div class="mt-16">
                    <label>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
                    <select id="autoBackup">
                      <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
                      <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
                      <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                      <option value="none">Ù…Ø¹Ø·Ù„</option>
                    </select>
                  </div>
                  <button class="btn btn-primary mt-16" id="saveBackupSettingsBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="toolbar mt-24">
          <button class="btn" id="backToHomeFromSettings">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
      </div>
    </section>

    <div class="footer">Â© <span id="year"></span> Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ â€“ ÙƒØ³Ù„Ø§. Ù†Ø¸Ø§Ù… Ø·Ø±ÙÙŠ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª (LocalStorage).<br>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù‚Ø³Ù… Ø§Ù„Ø³ÙŠØ¯ Ù…ØµØ·ÙÙŠ Ø§Ù„Ø­Ø§Ø¬</div>
  </div>

  <script>
    // ====== Utilities ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmtDate = d => d ? new Date(d).toLocaleDateString('ar-EG') : '';
    const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

    const Storage = {
      get(){ return JSON.parse(localStorage.getItem('ot_lists')||'[]');},
      set(arr){ localStorage.setItem('ot_lists', JSON.stringify(arr));},
      getUsers(){ 
        const users = JSON.parse(localStorage.getItem('ot_users')||'[]');
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if (users.length === 0) {
          const defaultUsers = [{id: 'admin', u:'admin', p:'1234', name:'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„', role:'admin'}];
          localStorage.setItem('ot_users', JSON.stringify(defaultUsers));
          return defaultUsers;
        }
        return users;
      },
      setUsers(arr){ localStorage.setItem('ot_users', JSON.stringify(arr));},
      getSettings(){ return JSON.parse(localStorage.getItem('ot_settings')||'{}');},
      setSettings(obj){ localStorage.setItem('ot_settings', JSON.stringify(obj));},
      export(){
        const data = {
          lists: Storage.get(),
          users: Storage.getUsers(),
          settings: Storage.getSettings(),
          version: '1.0',
          exportedAt: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'backup_ot_system.json';
        a.click();
      },
      async import(file){
        const txt = await file.text();
        const data = JSON.parse(txt);
        
        if(data.lists) Storage.set(data.lists);
        if(data.users) Storage.setUsers(data.users);
        if(data.settings) Storage.setSettings(data.settings);
        
        UI.refreshLists();
        alert('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
      }
    };

    const Auth = {
      users: Storage.getUsers(),
      login(u,p){
        const hit = this.users.find(x=>x.u===u && x.p===p);
        if(hit && hit.active !== false){ 
          sessionStorage.setItem('ot_user', JSON.stringify(hit)); 
          return hit;
        }
        return null;
      },
      current(){ return JSON.parse(sessionStorage.getItem('ot_user')||'null'); },
      logout(){ sessionStorage.removeItem('ot_user'); },
      hasPermission(requiredRole){
        const user = this.current();
        if(!user) return false;
        
        const roles = { admin: 3, write: 2, read: 1 };
        return roles[user.role] >= roles[requiredRole];
      },
      updateUsers(users) {
        this.users = users;
        Storage.setUsers(users);
      }
    };

    // ====== State ======
    const State = { currentListId:null, currentSettingsTab: 'users' };

    // ====== Routing / Screens ======
    function show(id){
      ['screen-login','screen-home','screen-editor','screen-reports','screen-settings'].forEach(s=>{
        const el = document.getElementById(s);
        if(el) el.classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
    }

    function requireAuth(){
      const me = Auth.current();
      $('#currentUser').textContent = me? `Ù…Ø±Ø­Ø¨Ø§ØŒ ${me.name} (${me.role})`: 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      $('#logoutBtn').style.display = me? 'inline-flex':'none';
      $('#settingsBtn').style.display = me? 'inline-flex':'none';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      if(me) {
        if(!Auth.hasPermission('write')) {
          $('#newListBtn').style.display = 'none';
          $('#backupBtn').style.display = 'none';
          $('#restoreBtn').style.display = 'none';
        } else {
          $('#newListBtn').style.display = 'inline-flex';
          $('#backupBtn').style.display = 'inline-flex';
          $('#restoreBtn').style.display = 'inline-flex';
        }
        
        if(!Auth.hasPermission('admin')) {
          $('#settingsBtn').style.display = 'none';
        }
      }
      
      show(me? 'screen-home':'screen-login');
    }

    // ====== UI Builders ======
    const UI = {
      refreshLists(){
        const tbody = $('#listsTable tbody');
        tbody.innerHTML = '';
        const q = $('#searchLists').value.trim();
        const all = Storage.get();
        const rows = all.filter(L=>{
          const hay = `${L.day} ${L.date} ${L.notes}`;
          return q? hay.includes(q):true;
        });
        rows.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
        for(const L of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${L.day||''}</td>
            <td>${fmtDate(L.date)}</td>
            <td><span class="badge">${(L.ops||[]).length}</span></td>
            <td>${L.notes||''}</td>
            <td class="row">
              <button class="btn" data-edit="${L.id}">ØªØ­Ø±ÙŠØ±</button>
              ${Auth.hasPermission('write') ? `
                <button class="btn" data-dup="${L.id}">Ù†Ø³Ø®</button>
                <button class="btn btn-danger" data-del="${L.id}">Ø­Ø°Ù</button>
              ` : ''}
            </td>`;
          tbody.appendChild(tr);
        }
      },
      loadListToEditor(list){
        $('#listDay').value = list.day||'';
        $('#listDate').value = list.date||'';
        $('#listNotes').value = list.notes||'';
        const tbody = $('#opsTable tbody');
        tbody.innerHTML='';
        (list.ops||[]).forEach((op,idx)=> tbody.appendChild(UI.opRow(op, idx+1)) );
      },
      opRow(op={}, serial){
        const tr = document.createElement('tr');
        const safe = k=> op[k]||'';
        tr.innerHTML = `
          <td class="muted">${serial}</td>
          <td><input data-k="name" value="${safe('name')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶"/></td>
          <td><input data-k="fileNo" value="${safe('fileNo')}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù"/></td>
          <td>
            <select data-k="opType">
              <option ${safe('opType')==='ÙƒØ¨ÙŠØ±Ø©'?'selected':''}>ÙƒØ¨ÙŠØ±Ø©</option>
              <option ${safe('opType')==='Ù…ØªÙˆØ³Ø·Ø©'?'selected':''}>Ù…ØªÙˆØ³Ø·Ø©</option>
              <option ${safe('opType')==='ØµØºÙŠØ±Ø©'?'selected':''}>ØµØºÙŠØ±Ø©</option>
            </select>
          </td>
          <td>
            <select data-k="anType">
              <option ${safe('anType')==='ÙƒØ§Ù…Ù„'?'selected':''}>ÙƒØ§Ù…Ù„</option>
              <option ${safe('anType')==='Ù†ØµÙÙŠ'?'selected':''}>Ù†ØµÙÙŠ</option>
            </select>
          </td>
          <td><input type="date" data-k="opDate" value="${safe('opDate')}"/></td>
          <td><input data-k="anesthetist" value="${safe('anesthetist')}" placeholder="Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±"/></td>
          <td><input data-k="doctor" value="${safe('doctor')}" placeholder="Ø§Ù„Ø·Ø¨ÙŠØ¨"/></td>
          <td><input data-k="preparer" value="${safe('preparer')}" placeholder="Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±"/></td>
          <td><input data-k="unit" value="${safe('unit')}" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø©"/></td>
          <td><input data-k="reason" value="${safe('reason')}" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"/></td>
          <td class="row">
            ${Auth.hasPermission('write') ? `
              <button class="btn" data-copy>Ù†Ø³Ø®</button>
              <button class="btn btn-danger" data-remove>Ø­Ø°Ù</button>
            ` : ''}
          </td>`;
        return tr;
      },
      refreshUsersTable() {
        const tbody = $('#usersTableBody');
        tbody.innerHTML = '';
        
        const currentUser = Auth.current();
        const users = Auth.users;
        
        users.forEach(user => {
          const tr = document.createElement('tr');
          
          // ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
          let roleText = '';
          let roleClass = '';
          if(user.role === 'admin') {
            roleText = 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…';
            roleClass = 'permission-admin';
          } else if(user.role === 'write') {
            roleText = 'Ù‚Ø±Ø§Ø¡Ø© ÙˆÙƒØªØ§Ø¨Ø©';
            roleClass = 'permission-write';
          } else {
            roleText = 'Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·';
            roleClass = 'permission-read';
          }
          
          tr.innerHTML = `
            <td>${user.u} ${currentUser && user.id === currentUser.id ? '(Ø£Ù†Øª)' : ''}</td>
            <td><span class="permission-badge ${roleClass}">${roleText}</span></td>
            <td>${user.active !== false ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</td>
            <td class="row">
              ${!currentUser || user.id !== currentUser.id ? `
                <button class="btn" data-user-edit="${user.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-danger" data-user-delete="${user.id}">Ø­Ø°Ù</button>
              ` : 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ'}
            </td>
          `;
          
          tbody.appendChild(tr);
        });
      },
      showSettingsTab(tabId) {
        // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        $('#users-tab').classList.add('hidden');
        $('#permissions-tab').classList.add('hidden');
        $('#system-tab').classList.add('hidden');
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        $(`#${tabId}-tab`).classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        $$('.settings-menu a').forEach(a => {
          a.classList.remove('active');
          if(a.dataset.tab === tabId) {
            a.classList.add('active');
          }
        });
        
        State.currentSettingsTab = tabId;
      }
    };

    // ====== List CRUD ======
    function getCurrent(){
      const id = State.currentListId;
      return Storage.get().find(x=>x.id===id);
    }

    function saveEditorToState(){
      if(!Auth.hasPermission('write')) {
        alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
        return;
      }
      
      const id = State.currentListId || uid();
      const all = Storage.get();
      let list = all.find(x=>x.id===id);
      if(!list){ list = {id, ops:[]}; all.push(list); }
      list.day = $('#listDay').value.trim();
      list.date = $('#listDate').value||'';
      list.notes = $('#listNotes').value.trim();
      // read rows
      const ops=[];
      $$('#opsTable tbody tr').forEach(tr=>{
        const obj={};
        $$('input,select', tr).forEach(el=>{ obj[el.dataset.k]=el.value.trim(); });
        // ignore empty rows (no name & no doctor)
        if(obj.name || obj.doctor) ops.push(obj);
      });
      list.ops = ops;
      Storage.set(all);
      State.currentListId = id;
      UI.refreshLists();
    }

    function deleteList(id){
      if(!Auth.hasPermission('write')) {
        alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø­Ø°Ù');
        return;
      }
      
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù„Ø³ØªÙ‘Ø©ØŸ')) return;
      const all = Storage.get().filter(x=>x.id!==id);
      Storage.set(all);
      if(State.currentListId===id) State.currentListId = null;
      UI.refreshLists();
    }

    // ====== Reports ======
    function gatherAllOps(){
      const out=[];
      for(const L of Storage.get()){
        (L.ops||[]).forEach((op,i)=> out.push({
          day:L.day||'', date:L.date||'', serial:i+1, ...op
        }));
      }
      return out;
    }

    function runSearch(){
      const from = $('#filterFrom').value? new Date($('#filterFrom').value):null;
      const to   = $('#filterTo').value? new Date($('#filterTo').value):null;
      const doc  = $('#filterDoctor').value.trim();
      const an   = $('#filterAnesth').value.trim();
      const prep = $('#filterPrep').value.trim();
      const unit = $('#filterUnit').value.trim();
      const opT  = $('#filterOpType').value;
      const anT  = $('#filterAnType').value;

      let rows = gatherAllOps();
      rows = rows.filter(r=>{
        const d = r.opDate? new Date(r.opDate): (r.date? new Date(r.date):null);
        if(from && (!d || d < from)) return false;
        if(to && (!d || d > to)) return false;
        if(doc && !(r.doctor||'').includes(doc)) return false;
        if(an && !(r.anesthetist||'').includes(an)) return false;
        if(prep && !(r.preparer||'').includes(prep)) return false;
        if(unit && !(r.unit||'').includes(unit)) return false;
        if(opT && r.opType!==opT) return false;
        if(anT && r.anType!==anT) return false;
        return true;
      });

      // table
      const tb = $('#reportTable tbody');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.day}</td>
          <td>${fmtDate(r.date)}</td>
          <td>${r.serial}</td>
          <td>${r.name||''}</td>
          <td>${r.fileNo||''}</td>
          <td>${r.opType||''}</td>
          <td>${r.anType||''}</td>
          <td>${r.anesthetist||''}</td>
          <td>${r.doctor||''}</td>
          <td>${r.preparer||''}</td>
          <td>${r.unit||''}</td>
          <td>${r.reason||''}</td>`;
        tb.appendChild(tr);
      });

      // stats
      const s = {
        total: rows.length,
        big: rows.filter(r=>r.opType==='ÙƒØ¨ÙŠØ±Ø©').length,
        medium: rows.filter(r=>r.opType==='Ù…ØªÙˆØ³Ø·Ø©').length,
        small: rows.filter(r=>r.opType==='ØµØºÙŠØ±Ø©').length,
        full: rows.filter(r=>r.anType==='ÙƒØ§Ù…Ù„').length,
        half: rows.filter(r=>r.anType==='Ù†ØµÙÙŠ').length,
      };
      const statsRow = $('#statsRow');
      statsRow.innerHTML = '';
      const box = (title,val)=>{
        const span = document.createElement('span');
        span.className='chip';
        span.textContent = `${title}: ${val}`;
        return span;
      };
      statsRow.append(
        box('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', s.total),
        box('ÙƒØ¨ÙŠØ±Ø©', s.big),
        box('Ù…ØªÙˆØ³Ø·Ø©', s.medium),
        box('ØµØºÙŠØ±Ø©', s.small),
        box('ØªØ®Ø¯ÙŠØ± ÙƒØ§Ù…Ù„', s.full),
        box('ØªØ®Ø¯ÙŠØ± Ù†ØµÙÙŠ', s.half),
      );
    }

    // ====== CSV Export ======
    function toCSV(rows, headers){
      const csv = [headers.join(',')].concat(rows.map(r=> headers.map(h=> (`${r[h]??''}`.replaceAll('"','""')) ).map(x=>`"${x}"`).join(',')) ).join('\n');
      return new Blob([csv], {type:'text/csv;charset=utf-8;'});
    }

    function exportListCSV(list){
      const headers = ['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„ØªØ§Ø±ÙŠØ®','#','Ø§Ù„Ø§Ø³Ù…','Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù','Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©','Ù†ÙˆØ¹ Ø§Ù„ØªØ®Ø¯ÙŠØ±','Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±','Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±','Ø§Ù„ÙˆØ­Ø¯Ø©','Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'];
      const rows = (list.ops||[]).map((op,i)=>({
        'Ø§Ù„ÙŠÙˆÙ…': list.day||'',
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': fmtDate(list.date),
        '#': i+1,
        'Ø§Ù„Ø§Ø³Ù…': op.name||'',
        'Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù': op.fileNo||'',
        'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©': op.opType||'',
        'Ù†ÙˆØ¹ Ø§Ù„ØªØ®Ø¯ÙŠØ±': op.anType||'',
        'Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±': op.anesthetist||'',
        'Ø§Ù„Ø·Ø¨ÙŠØ¨': op.doctor||'',
        'Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±': op.preparer||'',
        'Ø§Ù„ÙˆØ­Ø¯Ø©': op.unit||'',
        'Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©': op.reason||'',
      }));
      const blob = toCSV(rows, headers);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª_${list.day||''}_${list.date||''}.csv`;
      a.click();
    }

    function exportReportCSV(){
      const headers = ['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„ØªØ§Ø±ÙŠØ®','#','Ø§Ù„Ø§Ø³Ù…','Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù','Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©','Ù†ÙˆØ¹ Ø§Ù„ØªØ®Ø¯ÙŠØ±','Ø§Ù„Ù…Ø®Ø¯Ù‘Ø±','Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ù…Ø­Ø¶Ù‘ÙØ±','Ø§Ù„ÙˆØ­Ø¯Ø©','Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'];
      const rows=[];
      $$('#reportTable tbody tr').forEach(tr=>{
        const cells = Array.from(tr.children).map(td=>td.textContent);
        const obj={}; headers.forEach((h,i)=>obj[h]=cells[i]||'');
        rows.push(obj);
      });
      const blob = toCSV(rows, headers);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.csv';
      a.click();
    }

    // ====== Printing ======
    function printElement(selector, title){
      const html = `<!doctype html><html dir="rtl" lang="ar"><head><meta charset="utf-8"><title>${title}</title>
      <style>
        body{font-family:Tajawal,Arial,sans-serif;padding:24px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ddd;padding:8px}
        th{background:#f3f4f6}
      </style></head><body>${document.querySelector(selector).outerHTML}</body></html>`;
      const w = window.open('', '_blank');
      w.document.write(html); w.document.close(); w.focus(); w.print();
    }

    // ====== Event Wiring ======
    window.addEventListener('DOMContentLoaded', ()=>{
      $('#year').textContent = new Date().getFullYear();

      // auth
      requireAuth();
      $('#loginBtn').onclick = ()=>{
        const u = $('#loginUser').value.trim();
        const p = $('#loginPass').value;
        const user = Auth.login(u,p);
        if(user){
          $('#loginPass').value='';
          requireAuth();
        } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      };
      $('#logoutBtn').onclick = ()=>{ Auth.logout(); requireAuth(); };
      $('#settingsBtn').onclick = ()=>{ 
        if(Auth.hasPermission('admin')) {
          UI.refreshUsersTable();
          UI.showSettingsTab('users');
          show('screen-settings'); 
        } else {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        }
      };

      // home
      UI.refreshLists();
      $('#searchLists').oninput = UI.refreshLists;
      $('#newListBtn').onclick = ()=>{ 
        if(Auth.hasPermission('write')) {
          State.currentListId=null; 
          UI.loadListToEditor({ops:[]}); 
          show('screen-editor'); 
        } else {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø³ØªØ© Ø¬Ø¯ÙŠØ¯Ø©');
        }
      };
      $('#reportsBtn').onclick = ()=>{ show('screen-reports'); runSearch(); };
      $('#backupBtn').onclick = ()=> Storage.export();
      $('#restoreBtn').onclick = ()=>{
        if(!Auth.hasPermission('write')) {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹');
          return;
        }
        const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
        inp.onchange = ()=> Storage.import(inp.files[0]).catch(e=>alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹: '+e.message));
        inp.click();
      };
      $('#listsTable').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.edit||btn.dataset.del||btn.dataset.dup;
        const all = Storage.get(); const L = all.find(x=>x.id===id);
        if(btn.dataset.edit){ 
          State.currentListId=id; 
          UI.loadListToEditor(L); 
          show('screen-editor'); 
        }
        if(btn.dataset.del){ 
          if(Auth.hasPermission('write')) {
            deleteList(id); 
          } else {
            alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø­Ø°Ù');
          }
        }
        if(btn.dataset.dup){ 
          if(Auth.hasPermission('write')) {
            const copy = JSON.parse(JSON.stringify(L)); 
            copy.id=uid(); 
            copy.day += ' (Ù†Ø³Ø®Ø©)'; 
            all.push(copy); 
            Storage.set(all); 
            UI.refreshLists(); 
          } else {
            alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø©');
          }
        }
      });

      // editor
      $('#addOpBtn').onclick = ()=>{
        if(Auth.hasPermission('write')) {
          $('#opsTable tbody').appendChild(UI.opRow({}, $$('#opsTable tbody tr').length+1));
        } else {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª');
        }
      };
      $('#opsTable').addEventListener('click', (e)=>{
        if(!Auth.hasPermission('write')) {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
          return;
        }
        
        const tr = e.target.closest('tr'); if(!tr) return;
        if(e.target.matches('[data-remove]')){ tr.remove(); reorderSerials(); }
        if(e.target.matches('[data-copy]')){
          const obj={}; $$('input,select', tr).forEach(el=> obj[el.dataset.k]=el.value );
          $('#opsTable tbody').appendChild(UI.opRow(obj, $$('#opsTable tbody tr').length+1));
        }
      });
      function reorderSerials(){ $$('#opsTable tbody tr').forEach((tr,i)=> tr.firstElementChild.textContent = i+1 ); }

      $('#saveListBtn').onclick = ()=>{ saveEditorToState(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); };
      $('#backToHomeFromEditor').onclick = ()=>{ saveEditorToState(); show('screen-home'); };
      $('#exportListBtn').onclick = ()=>{ const L = getCurrent(); if(L) exportListCSV(L); };
      $('#printListBtn').onclick = ()=> printElement('#opsTable', 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');

      // reports
      $('#runSearchBtn').onclick = runSearch;
      $('#clearFiltersBtn').onclick = ()=>{ ['filterFrom','filterTo','filterDoctor','filterAnesth','filterPrep','filterUnit'].forEach(id=> document.getElementById(id).value=''); $('#filterOpType').value=''; $('#filterAnType').value=''; runSearch(); };
      $('#exportReportBtn').onclick = exportReportCSV;
      $('#printReportBtn').onclick = ()=> printElement('#reportTable', 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª');
      $('#backToHomeFromReports').onclick = ()=> show('screen-home');
      
      // settings
      $('#backToHomeFromSettings').onclick = ()=> show('screen-home');
      
      // ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      $$('.settings-menu a').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          UI.showSettingsTab(a.dataset.tab);
        });
      });
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
      $('#addUserBtn').onclick = () => {
        const username = $('#newUserName').value.trim();
        const password = $('#newUserPass').value;
        const role = $('#newUserRole').value;
        
        if(!username || !password) {
          alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
          return;
        }
        
        if(Auth.users.some(u => u.u === username)) {
          alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
          return;
        }
        
        const newUser = {
          id: uid(),
          u: username,
          p: password,
          name: username,
          role: role,
          active: true
        };
        
        Auth.users.push(newUser);
        Auth.updateUsers(Auth.users);
        UI.refreshUsersTable();
        
        $('#newUserName').value = '';
        $('#newUserPass').value = '';
        
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
      };
      
      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      $('#usersTableBody').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        
        const userId = btn.dataset.userEdit || btn.dataset.userDelete;
        const user = Auth.users.find(u => u.id === userId);
        
        if(!user) return;
        
        if(btn.dataset.userEdit) {
          const newPassword = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±):');
          if(newPassword === null) return; // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø±
          
          if(newPassword) {
            user.p = newPassword;
          }
          
          const newRole = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (admin/write/read):', user.role);
          if(newRole && ['admin', 'write', 'read'].includes(newRole)) {
            user.role = newRole;
          }
          
          Auth.updateUsers(Auth.users);
          UI.refreshUsersTable();
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        if(btn.dataset.userDelete) {
          if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.u}"ØŸ`)) return;
          
          Auth.users = Auth.users.filter(u => u.id !== userId);
          Auth.updateUsers(Auth.users);
          UI.refreshUsersTable();
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
        }
      });
      
      // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
      $('#primaryColor').addEventListener('input', (e) => {
        $('#primaryColorPreview').style.backgroundColor = e.target.value;
      });
      
      $('#accentColor').addEventListener('input', (e) => {
        $('#accentColorPreview').style.backgroundColor = e.target.value;
      });
      
      // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±
      $('#saveThemeBtn').onclick = () => {
        const primaryColor = $('#primaryColor').value;
        const accentColor = $('#accentColor').value;
        
        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const settings = Storage.getSettings();
        settings.theme = { primaryColor, accentColor };
        Storage.setSettings(settings);
        
        alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­');
      };
      
      // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
      $('#saveBackupSettingsBtn').onclick = () => {
        const autoBackup = $('#autoBackup').value;
        
        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const settings = Storage.getSettings();
        settings.autoBackup = autoBackup;
        Storage.setSettings(settings);
        
        alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
      };
    });
  </script>
</body>
</html>